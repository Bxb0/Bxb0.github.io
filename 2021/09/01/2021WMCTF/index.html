<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 4.2.1"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/2.ico"><link rel="icon" type="image/png" sizes="16x16" href="/images/2.ico"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"bxb0.github.io",root:"/",scheme:"Gemini",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:null},back2top:{enable:!0,sidebar:!0,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="2021WMCTF中的Re1&amp;Re2"><meta property="og:type" content="article"><meta property="og:title" content="2021WMCTF"><meta property="og:url" content="https://bxb0.github.io/2021/09/01/2021WMCTF/index.html"><meta property="og:site_name" content="Bxb0&#39;s blog"><meta property="og:description" content="2021WMCTF中的Re1&amp;Re2"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://i.loli.net/2021/09/01/wZVrS5mPcqgOIBf.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/UySsFAqPHh9vrlg.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/i83BrAKLlRDZt6F.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/O7oRGYaErsZPN6p.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/8fCxu3cEKjw5pDi.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/wCkvUQcpjbKXltx.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/mMqW2y8pCfrTDeU.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/x5Vl4gT7pdfGnKo.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/ycgMrSDpYtGohUf.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/HDFh2Ylg8VEes59.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/LuSIUtCTyFOZ1qm.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/4slm7KUnSZgWqM9.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/lWCZjIF1rBvfhKG.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/m2RqHBcrTwPhI8Q.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/aT1OC7P96SeRlNo.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/PzsK7JmUxGaF5tX.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/6iuHhIPyFMdlsUv.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/kQNo85bOAezrqKy.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/rX5yIGZRMNAvmuB.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/EyKpMnfreXzmAiT.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/Xf1RIjZmrEdPyag.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/RKC9vtMTyBU7L1q.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/PfgNijUFCT9zAOS.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/rzbtR2GvBUmy3Mj.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/25lEOhyKdwnDYjA.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/51NxLIjvF3lfT8X.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/Aoj8Q4YzOI5EPfX.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/MvGDm9iFVQZ1bBr.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/mc8Uue5BGsC7Mpl.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/Em4jeAbICkqVFuY.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/AapBzxRw2Uv8Y9u.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/nshTY1NwpkPWFSr.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/zOmXTFrq483bZoM.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/AnKeum1spg8UWMC.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/VdKjhXruy57g24C.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/ZI4FVAJx73hXOsT.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/2mdSZn8XcskBUFN.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/ZgiXE5c3qsU7u8D.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/OFP17jzvpDQymXi.png"><meta property="og:image" content="https://i.loli.net/2021/09/01/J3vIc89jB15GXWh.png"><meta property="article:published_time" content="2021-09-01T02:42:00.000Z"><meta property="article:modified_time" content="2021-09-01T03:24:05.483Z"><meta property="article:author" content="ooo"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://i.loli.net/2021/09/01/wZVrS5mPcqgOIBf.png"><link rel="canonical" href="https://bxb0.github.io/2021/09/01/2021WMCTF/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"en"}</script><title>2021WMCTF | Bxb0's blog</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="Bxb0's blog" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">Bxb0's blog</h1><span class="logo-line-after"><i></i></span></a></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i> Home</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i> Categories<span class="badge">15</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i> Archives<span class="badge">45</span></a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> Search</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" placeholder="Searching..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en"><link itemprop="mainEntityOfPage" href="https://bxb0.github.io/2021/09/01/2021WMCTF/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="ooo"><meta itemprop="description" content="0x446e37fb"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Bxb0's blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> 2021WMCTF</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">Posted on</span> <time title="Created: 2021-09-01 10:42:00" itemprop="dateCreated datePublished" datetime="2021-09-01T10:42:00+08:00">2021-09-01</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a></span></span><br><span class="post-meta-item" title="Symbols count in article"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">Symbols count in article:</span> <span>18k</span></span><span class="post-meta-item" title="Reading time"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">Reading time &asymp;</span> <span>16 mins.</span></span></div></header><div class="post-body" itemprop="articleBody"><p>2021WMCTF中的Re1&amp;Re2<a id="more"></a></p><p><img src="https://i.loli.net/2021/09/01/wZVrS5mPcqgOIBf.png" alt="image-20210901104413498"></p><h3 id="Re1"><a href="#Re1" class="headerlink" title="Re1"></a>Re1</h3><p>首先ida反编译main函数会报错，这个一般是程序中有花指令导致的。</p><p><img src="https://i.loli.net/2021/09/01/UySsFAqPHh9vrlg.png" alt="image-20210829170116423"></p><p>因为main函数比较大，用提示成功字符串定位到最后的汇编代码，向上翻翻便看见出问题的代码。</p><p><img src="https://i.loli.net/2021/09/01/i83BrAKLlRDZt6F.png" alt="image-20210829170943477"></p><p>双击该地址，可以发现ida将这段数据解析成了代码且最上面有一个设置的条件绝对跳转跳过了执行下面的错误带代码，这里可以直接把jnb改成jmp，并把下面垃圾代码nop掉。</p><p><img src="https://i.loli.net/2021/09/01/O7oRGYaErsZPN6p.png" alt="image-20210829171215050"></p><p>继续向上翻又可以看见如下的花指令：不断跳转到下一条指令，统统nop掉即可。</p><p><img src="https://i.loli.net/2021/09/01/8fCxu3cEKjw5pDi.png" alt="image-20210829171732791"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ida_bytes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">addr = <span class="number">0x140002DEC</span></span><br><span class="line"><span class="keyword">while</span> addr &lt;= <span class="number">0x140002DFF</span>:</span><br><span class="line">    patch_byte(addr, <span class="number">0x90</span>)</span><br><span class="line">    addr += <span class="number">1</span></span><br><span class="line">print(<span class="string">'*'</span>*<span class="number">100</span>)</span><br></pre></td></tr></table></figure><p>然后我们就可以反编译了。</p><p>先看到对输入的处理：</p><p>开始判断了flag长度范围[12, 45]，然后判断格式是否是WMCTF{}</p><p><img src="https://i.loli.net/2021/09/01/wCkvUQcpjbKXltx.png" alt="image-20210829172248646"></p><p>接着申请了576字节大小的空间block，并把输入的除去格式（WMCTF{}外）的前4个字节以如下方式填入block</p><p><img src="https://i.loli.net/2021/09/01/mMqW2y8pCfrTDeU.png" alt="image-20210829172605480"></p><p>再把输入的除去格式（WMCTF{}外）的4-20字节填入block+530开始的位置。</p><p><img src="https://i.loli.net/2021/09/01/x5Vl4gT7pdfGnKo.png" alt="image-20210829172802321"></p><p>最后就是将剩下的输入以<strong>_@#?!&amp;-$+</strong>为区分，分别进行不同的处理。其中输入是hex形式，先把每4个hex转化两字节数据后，再用第一字节作为index，第二字节作为数据对block进行操作。</p><p><img src="https://i.loli.net/2021/09/01/ycgMrSDpYtGohUf.png" alt="image-20210829173407068"></p><p>下面再看加密部分：</p><p>首先sub_7FF79BD33960()函数也是加了上面所说的花指令，去除后看到伪代码，用CRC算法生成256个4字节数据：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">__<span class="function">int64 <span class="title">sub_7FF79BD33960</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> j; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> i; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">0x100</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = i;</span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; <span class="number">8</span>; ++j )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( (v3 &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">        v3 = (v3 &gt;&gt; <span class="number">1</span>) ^ <span class="number">0x8320EDB8</span>;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        v3 &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    dword_7FF79BD57A70[i] = v3;</span><br><span class="line">    result = i + <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后对前4字节填充的block，用CRC生成的256个4字节数据，经过移位，异或运算生成4个4字节数据后与硬编码的数据比较：</p><p><img src="https://i.loli.net/2021/09/01/HDFh2Ylg8VEes59.png" alt="image-20210829174325762"></p><p><img src="https://i.loli.net/2021/09/01/LuSIUtCTyFOZ1qm.png" alt="image-20210829174351699"></p><p>最后使用最开始在block填充的<strong>0xDEAD</strong>改变<strong>vars88，vaes84, vaes80, v58</strong>后作为密钥对除去WMCTF{}格式外输入的4-20字节进行2个xtea加密。</p><p><img src="https://i.loli.net/2021/09/01/4slm7KUnSZgWqM9.png" alt="image-20210829175035556"></p><p>下面开始解密：</p><p>首先用z3将vars88，vaes84, vaes80, v58四个值就求出来：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">s = Solver()</span><br><span class="line"></span><br><span class="line">key = [BitVec(<span class="string">'x%d'</span>%i, <span class="number">32</span>) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>)]</span><br><span class="line">s.add((key[<span class="number">0</span>]+key[<span class="number">1</span>]) == <span class="number">0x11AB7A7A</span>)</span><br><span class="line">s.add(key[<span class="number">1</span>]-key[<span class="number">2</span>] == <span class="number">0x1CD4F222</span>)</span><br><span class="line">s.add(key[<span class="number">2</span>]+key[<span class="number">3</span>] == <span class="number">0xC940F021</span>)</span><br><span class="line">s.add(key[<span class="number">0</span>]+key[<span class="number">2</span>]-key[<span class="number">3</span>] == <span class="number">0x7C7D68D1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> s.check() == sat:</span><br><span class="line">    m = s.model()</span><br><span class="line">    m = [m[key[i]].as_long() <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>)]</span><br><span class="line">    print(m)</span><br><span class="line"><span class="keyword">else</span>: </span><br><span class="line">    print(<span class="string">'Not Found!'</span>)</span><br><span class="line"><span class="comment">#[2750330814, 1841087164, 1357369498, 2019106695]</span></span><br></pre></td></tr></table></figure><p>再用上面4个数据依次爆破出对应的4字节明文数据：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> box[<span class="number">256</span>];</span><br><span class="line"><span class="keyword">char</span> res[<span class="number">5</span>];</span><br><span class="line"><span class="keyword">int</span> number[] = &#123;<span class="number">0x100</span>, <span class="number">0x100</span>, <span class="number">0xf</span>, <span class="number">0x1c</span>&#125;;</span><br><span class="line"><span class="keyword">unsigned</span> enc[] = &#123;<span class="number">2750330814</span>, <span class="number">1841087164</span>, <span class="number">1357369498</span>, <span class="number">2019106695</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">gen_box</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> j; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> i; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">0x100</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = i;</span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; <span class="number">8</span>; ++j )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( (v3 &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">        v3 = (v3 &gt;&gt; <span class="number">1</span>) ^ <span class="number">0x8320EDB8</span>;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        v3 &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    box[i] = v3;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">fun1</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> a1, <span class="keyword">unsigned</span> <span class="keyword">char</span> a2[<span class="number">256</span>], <span class="keyword">unsigned</span> <span class="keyword">int</span> a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> v4; <span class="comment">// [rsp+4h] [rbp-1Ch]</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> v5; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">	</span><br><span class="line">	v5 = <span class="number">0</span>;</span><br><span class="line">	v4 = a1;</span><br><span class="line">	<span class="keyword">while</span> ( v5 &lt; a3 )</span><br><span class="line">		v4 = (v4 &gt;&gt; <span class="number">8</span>) ^ box[(<span class="keyword">unsigned</span> <span class="keyword">char</span>)(a2[v5++] ^ v4)];</span><br><span class="line">	<span class="keyword">return</span> a1 ^ v4;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">bp</span><span class="params">(<span class="keyword">int</span> up, <span class="keyword">int</span> number, <span class="keyword">unsigned</span> <span class="keyword">int</span> pre, <span class="keyword">unsigned</span> <span class="keyword">int</span> next)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">127</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">char</span> block[<span class="number">256</span>];</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; number; j++)</span><br><span class="line">		&#123;</span><br><span class="line">			block[j] = i+j+up;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(fun1(pre, block, number) == next)</span><br><span class="line">			<span class="keyword">return</span> i;	</span><br><span class="line">	&#125;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	gen_box();</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(i == <span class="number">0</span>)</span><br><span class="line">			res[i] = bp(i, number[i], <span class="number">-2</span>, enc[i]);</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			res[i] = bp(i, number[i], enc[i<span class="number">-1</span>], enc[i]);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">puts</span>(res);	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Hah4</span></span><br></pre></td></tr></table></figure><p>用满足前4字节的测试输入<strong>WMCTF{Hah41111111111111111}</strong>输入程序，然后在xtea加密前取出密钥：</p><p><img src="https://i.loli.net/2021/09/01/lWCZjIF1rBvfhKG.png" alt="image-20210829182648792"></p><p>但用这个密钥解密密文怎么都不正确。。还测试了自己的xtea解密好几遍，这里卡了好一会。</p><p>后面确定肯定是密钥的问题，但输入的前4字节是满足要求的，密钥是通过前4字节明文算出来的。但注意这里的密钥还用开始在block填充的<strong>0xDEAD</strong>的经过了变换的。这让我想到我忽略了输入的（WMCTF{}格式外）20字节后处理，开始闲麻烦懒得看直接跳过了。</p><p>所以问题现在应该就出在了有两个字节数据对密钥的影响。</p><p>爆破这2个字节，从解密结果中看像是flag的片段的：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt; </span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">get_delat</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> ans = <span class="number">0</span>, delat = <span class="number">0x667E5433</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">32</span>; i++)</span><br><span class="line">		ans -= delat;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> ans;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">decrypt1</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> num_rounds, <span class="keyword">uint32_t</span> v[<span class="number">2</span>], <span class="keyword">uint32_t</span> <span class="keyword">const</span> key[<span class="number">4</span>])</span></span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> i;  </span><br><span class="line">    <span class="keyword">uint32_t</span> v0 = v[<span class="number">0</span>], v1 = v[<span class="number">1</span>], delta = <span class="number">0x667E5433</span>, sum = get_delat();</span><br><span class="line">	<span class="comment">//printf("%x", sum);  </span></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; num_rounds; i++)</span><br><span class="line">    &#123;  </span><br><span class="line">        v1 -= (((v0 &lt;&lt; <span class="number">4</span>) ^ (v0 &gt;&gt; <span class="number">5</span>)) + v0) ^ (sum + key[(sum&gt;&gt;<span class="number">11</span>) &amp; <span class="number">3</span>]);  </span><br><span class="line">        sum += delta;  </span><br><span class="line">        v0 -= (((v1 &lt;&lt; <span class="number">4</span>) ^ (v1 &gt;&gt; <span class="number">5</span>)) + v1) ^ (sum + key[sum &amp; <span class="number">3</span>]);  </span><br><span class="line">    &#125;  </span><br><span class="line">    v[<span class="number">0</span>]=v0, v[<span class="number">1</span>]=v1;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">check</span><span class="params">(<span class="keyword">unsigned</span> a)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(((<span class="keyword">char</span> *)&amp;a)[i] &lt; <span class="number">32</span> || ((<span class="keyword">char</span> *)&amp;a)[i] &gt; <span class="number">127</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//['a3eeb7be', '6dbcc2bc', '50e7d09a', '78591f87']</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">uint32_t</span> k[<span class="number">4</span>]=&#123;<span class="number">0x78591FAD</span>, <span class="number">0x6DBCC2BC</span>, <span class="number">0xA3EEB7BE</span>, <span class="number">0x50E7DE9A</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">10</span>; i &lt; <span class="number">0xff</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">    	<span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">0xff</span>; j++)</span><br><span class="line">    	&#123;</span><br><span class="line">    		<span class="keyword">uint32_t</span> v[<span class="number">2</span>]=&#123;<span class="number">0x1989FB2B</span>, <span class="number">0x83F5A243</span>&#125;;</span><br><span class="line">    		k[<span class="number">3</span>] &amp;= <span class="number">0xFFFF00FF</span>;</span><br><span class="line">    		k[<span class="number">3</span>] |= i &lt;&lt; <span class="number">8</span>;</span><br><span class="line">    		k[<span class="number">0</span>] &amp;= <span class="number">0xFFFFFF00</span>;</span><br><span class="line">    		k[<span class="number">0</span>] |= j;</span><br><span class="line">    		</span><br><span class="line">    		<span class="keyword">unsigned</span> <span class="keyword">int</span> r=<span class="number">32</span>;</span><br><span class="line">    		decrypt1(r, v, k);</span><br><span class="line">				</span><br><span class="line">			<span class="keyword">if</span>(check(v[<span class="number">0</span>]) &amp;&amp; check(v[<span class="number">1</span>]))</span><br><span class="line">			&#123;</span><br><span class="line">    			<span class="keyword">for</span>(<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; <span class="number">8</span>; k++)</span><br><span class="line">    			&#123;</span><br><span class="line">    				<span class="built_in">printf</span>(<span class="string">"%c"</span>, ((<span class="keyword">char</span> *)v)[k]);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">" %x %x"</span>, i, j);</span><br><span class="line">				<span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">pWRTPO&#123;&gt; 13 9f</span></span><br><span class="line"><span class="comment">&lt;&lt;R|CJA&lt; 24 c7</span></span><br><span class="line"><span class="comment">\o&#123;2%lSf 28 7f</span></span><br><span class="line"><span class="comment">t&lt;o.:RMY 2d 69</span></span><br><span class="line"><span class="comment">b%AGkVTt 36 2d</span></span><br><span class="line"><span class="comment">e.xQVP!| 53 0</span></span><br><span class="line"><span class="comment">0bOMoJI8 54 b1</span></span><br><span class="line"><span class="comment">"pWU3*@+ 73 d2</span></span><br><span class="line"><span class="comment">&gt;]zSE&gt;?d 81 d7</span></span><br><span class="line"><span class="comment">(sqF m# 8a 6b</span></span><br><span class="line"><span class="comment">Z,wRg8T_ 92 76</span></span><br><span class="line"><span class="comment">yOu_L1kE b7 ad</span></span><br><span class="line"><span class="comment">!vta&amp;K]M ba d3</span></span><br><span class="line"><span class="comment">K?Gl@~Rw bf b5</span></span><br><span class="line"><span class="comment">1C ="`~p c3 71</span></span><br><span class="line"><span class="comment">?&amp;bqWg]_ cd b1</span></span><br><span class="line"><span class="comment">SX|6u|v f4 43</span></span><br><span class="line"><span class="comment">+zWv6`!C fb a2</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p>可以看到<strong>yOu_L1kE</strong>，满足要求的两个字节是<strong>0xb7 0xad</strong></p><p>然后解密2段密文再按一定顺序拼接一下得到：<strong>_D0_yOu_L1kE_It!</strong></p><p>现在就是去求<strong>_@#?!&amp;-$+</strong>对应的处理函数怎么才能将<strong>*((_WORD *)Block + 273)</strong>的0xDEAD的改为<strong>0xB7AD</strong>。</p><p>输入为hex，4字节为一组转化为2个byte，第一个byte是index，第二个byte是data</p><p>根据要求推算出这样一个顺序是满足b要求的：</p><p>首先<strong>@</strong>对应的处理函数将block[256] = 0xFE。注意下面是char a2，所以传入0xFF就是-1了，因此满足输入为：<strong>@FFFE</strong></p><p><img src="https://i.loli.net/2021/09/01/m2RqHBcrTwPhI8Q.png" alt="image-20210829184654158"></p><p>然后<strong>#</strong>对应的处理函数将block[528] = 0x20，因此满足输入：<strong>#0F20</strong></p><p><img src="https://i.loli.net/2021/09/01/aT1OC7P96SeRlNo.png" alt="image-20210829185055634"></p><p>最后<strong>-</strong>对应的处理函数将block[527] = 0xB7，也是我们最后的终点。因此满足输入：<strong>-11B7</strong></p><p><img src="https://i.loli.net/2021/09/01/PzsK7JmUxGaF5tX.png" alt="image-20210829185410469"></p><p>可以看到上面要能执行最后的<strong>*(_BYTE *)(a1 + 530 + a2) = a3;</strong>要求是(*(unsigned __int16 *)(a1 + 528) % 16) == 0，(unsigned int)(*(unsigned __int16 *)(a1 + 528) / 16) &lt; 3</p><p>用这2个限制爆破得到：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = [i <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0xff</span>) <span class="keyword">if</span> i%<span class="number">16</span> == <span class="number">0</span> <span class="keyword">and</span> i/<span class="number">16</span> &lt; <span class="number">3</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a</span><br><span class="line">[<span class="number">0</span>, <span class="number">16</span>, <span class="number">32</span>]</span><br></pre></td></tr></table></figure><p>而我们的index为17且<strong>index&lt;*(unsigned __int16 *)(a1 + 528)</strong>，所以满足要求的就只有最后的32了，故上面<strong>#</strong>对应的处理函数要将block[528] = 0x20。</p><p>最后将我们的所有输入拼接起来得到flag：</p><p><strong>WMCTF{Hah4_D0_yOu_L1kE_It!@FFFE#0F20-11B7}</strong></p><h3 id="Re2"><a href="#Re2" class="headerlink" title="Re2"></a>Re2</h3><p>jadx打开app，可以看到关键在native层。</p><p><img src="https://i.loli.net/2021/09/01/6iuHhIPyFMdlsUv.png" alt="image-20210830093652342"></p><p>到so文件找到<strong>JNI_Onload</strong></p><p><img src="https://i.loli.net/2021/09/01/kQNo85bOAezrqKy.png" alt="image-20210830093939955"></p><p>其中，上面的JNI_Onload根据sub_7079FF9BBC函数的返回值注册不同的函数。</p><p>看到sub_7079FF9BBC：它通过查看<strong>/data/local/su</strong>是否存在，也就是判断我们的运行环境中有没有root</p><p><img src="https://i.loli.net/2021/09/01/rX5yIGZRMNAvmuB.png" alt="image-20210830094108535"></p><p>所以JNI_Onload是根据运行环境是否root注册不同的函数来执行。</p><p>接着我把程序在root与非root手机运行来看一下，root下运行随便输入后显示：<strong>fake branch</strong>，而在非root的手机上运行随便输入后显示：<strong>failed,please try again!!!</strong>，以此可以得出，我们要分析的非root才注册的函数。</p><p>然后也去看了一下root下注册的假流程：经过上面一些加密后最终都是返回同一个字符串。</p><p><img src="https://i.loli.net/2021/09/01/EyKpMnfreXzmAiT.png" alt="image-20210830094927683"></p><p>查看返回的字符串，发现并不是字符串数据，从交叉引用发现.init_array中一些初始化函数对其进行了解密。</p><p><img src="https://i.loli.net/2021/09/01/Xf1RIjZmrEdPyag.png" alt="image-20210830095445346"></p><p>并且.init_array中初始化函数动态解密了程序中很多数据：</p><p><img src="https://i.loli.net/2021/09/01/RKC9vtMTyBU7L1q.png" alt="image-20210830095630836"></p><p>对上面假流程返回的字符串异或0x6d解密后得到：fake branch</p><p><img src="https://i.loli.net/2021/09/01/PfgNijUFCT9zAOS.png" alt="image-20210830095730148"></p><p>再看到正确分支流程：先异或解密一些数据后注册了如下的函数。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">jstring __<span class="function">fastcall <span class="title">sub_7079FF9134</span><span class="params">(JNIEnv *a1, __int64 a2, __int64 a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v5; <span class="comment">// x21</span></span><br><span class="line">  _BYTE *v6; <span class="comment">// x20</span></span><br><span class="line">  <span class="keyword">char</span> *v7; <span class="comment">// x21</span></span><br><span class="line">  __int64 v8; <span class="comment">// x0</span></span><br><span class="line">  <span class="keyword">char</span> *v9; <span class="comment">// x1</span></span><br><span class="line">  __int64 v10; <span class="comment">// x8</span></span><br><span class="line">  <span class="keyword">size_t</span> v11; <span class="comment">// w0</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v12; <span class="comment">// x1</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v13; <span class="comment">// x1</span></span><br><span class="line">  jstring v14; <span class="comment">// x19</span></span><br><span class="line">  _BYTE v16[<span class="number">56</span>]; <span class="comment">// [xsp-30h] [xbp-170h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v17[<span class="number">2</span>]; <span class="comment">// [xsp+8h] [xbp-138h] BYREF</span></span><br><span class="line">  <span class="keyword">char</span> *v18; <span class="comment">// [xsp+18h] [xbp-128h]</span></span><br><span class="line">  __int128 v19; <span class="comment">// [xsp+20h] [xbp-120h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v20[<span class="number">2</span>]; <span class="comment">// [xsp+38h] [xbp-108h] BYREF</span></span><br><span class="line">  <span class="keyword">char</span> *v21; <span class="comment">// [xsp+48h] [xbp-F8h]</span></span><br><span class="line">  __int64 v22; <span class="comment">// [xsp+F8h] [xbp-48h]</span></span><br><span class="line"></span><br><span class="line">  v22 = *(_QWORD *)(_ReadStatusReg(ARM64_SYSREG(<span class="number">3</span>, <span class="number">3</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">2</span>)) + <span class="number">40</span>);</span><br><span class="line">  strcpy_0(v17, (<span class="keyword">char</span> *)&amp;xmmword_707A02F0A0);</span><br><span class="line">  v5 = (*a1)-&gt;GetStringUTFChars(a1, a3, <span class="number">0L</span>L);</span><br><span class="line">  <span class="keyword">if</span> ( (*a1)-&gt;GetStringLength(a1, (jstring)a3) == <span class="number">32</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v6 = (_BYTE *)<span class="keyword">operator</span> <span class="keyword">new</span>[](<span class="number">0x21</span>uLL);</span><br><span class="line">    __strcpy_chk(v6, v5, <span class="number">33L</span>L);</span><br><span class="line">    v7 = (<span class="keyword">char</span> *)<span class="keyword">operator</span> <span class="keyword">new</span>[](<span class="number">0x1E</span>uLL);</span><br><span class="line">    sub_7079FF9E80();</span><br><span class="line">    v8 = __strlen_chk(v7, <span class="number">0x1E</span>u);</span><br><span class="line">    v7[(<span class="keyword">int</span>)v8] = <span class="number">102</span>;</span><br><span class="line">    v7[((v8 &lt;&lt; <span class="number">32</span>) + <span class="number">0x100000000</span>LL) &gt;&gt; <span class="number">32</span>] = <span class="number">108</span>;</span><br><span class="line">    v7[((v8 &lt;&lt; <span class="number">32</span>) + <span class="number">0x200000000</span>LL) &gt;&gt; <span class="number">32</span>] = <span class="number">103</span>;</span><br><span class="line">    v7[((v8 &lt;&lt; <span class="number">32</span>) + <span class="number">0x300000000</span>LL) &gt;&gt; <span class="number">32</span>] = <span class="number">0</span>;</span><br><span class="line">    v19 = xmmword_707A01E5D0;</span><br><span class="line">    sub_7079FFA934((__int64)v20, v7, (<span class="keyword">long</span> <span class="keyword">double</span> *)&amp;v19);</span><br><span class="line">    sub_7079FFAE6C(v20, v6, <span class="number">0x20</span>uLL);</span><br><span class="line">    strcpy_0(v20, (<span class="keyword">char</span> *)&amp;qword_707A02F058);</span><br><span class="line">    <span class="keyword">if</span> ( (v20[<span class="number">0</span>] &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">      v9 = v21;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      v9 = (<span class="keyword">char</span> *)v20 + <span class="number">1</span>;</span><br><span class="line">    sub_7079FFA624((<span class="keyword">int</span>)&amp;v19, v9);</span><br><span class="line">    v10 = <span class="number">0L</span>L;</span><br><span class="line">    <span class="keyword">while</span> ( v16[v10] == stru_707A02F000[<span class="number">0</span>].n128_u8[v10] )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( ++v10 == <span class="number">32</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v11 = <span class="built_in">strlen</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;aQpyl);</span><br><span class="line">        sub_7079FF9670((<span class="keyword">int</span>)v17, &amp;aQpyl, v11);</span><br><span class="line">        <span class="keyword">if</span> ( (v17[<span class="number">0</span>] &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">          v12 = v18;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          v12 = (<span class="keyword">char</span> *)v17 + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_18;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( (v17[<span class="number">0</span>] &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">      v12 = v18;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      v12 = (<span class="keyword">char</span> *)v17 + <span class="number">1</span>;</span><br><span class="line">LABEL_18:</span><br><span class="line">    v14 = (*a1)-&gt;NewStringUTF(a1, v12);</span><br><span class="line">    <span class="keyword">if</span> ( (v20[<span class="number">0</span>] &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">      <span class="function"><span class="keyword">operator</span> <span class="title">delete</span><span class="params">(v21)</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (v17[<span class="number">0</span>] &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">      v13 = v18;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      v13 = (<span class="keyword">char</span> *)v17 + <span class="number">1</span>;</span><br><span class="line">    v14 = (*a1)-&gt;NewStringUTF(a1, v13);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( (v17[<span class="number">0</span>] &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">    <span class="function"><span class="keyword">operator</span> <span class="title">delete</span><span class="params">(v18)</span></span>;</span><br><span class="line">  <span class="keyword">return</span> v14;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先简单静态分析一下，开始是判断输入的长度是否为32。</p><p>然后sub_7B4933FE80函数读取某个文件内容经过对比后返回一串字符串：</p><p><img src="https://i.loli.net/2021/09/01/rzbtR2GvBUmy3Mj.png" alt="image-20210831211743715"></p><p>后面接着对上面获取到的字符串进行如下赋值：</p><p><img src="https://i.loli.net/2021/09/01/25lEOhyKdwnDYjA.png" alt="image-20210901101308736"></p><p>其实就是在其末尾加上<strong>flg</strong></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">len = <span class="built_in">strlen</span>(init_key);</span><br><span class="line">init_key[len] = <span class="string">'f'</span>;</span><br><span class="line">init_key[len+<span class="number">1</span>] = <span class="string">'l'</span>;</span><br><span class="line">init_key[len+<span class="number">2</span>] = <span class="string">'g'</span>;</span><br><span class="line">init_key[len+3] = '\x0';</span><br></pre></td></tr></table></figure><p>接着sub_7B49340934函数传入两个参数，其中的sub_7B49340820函数用了传入的一个参数串进行aes的密钥扩展：字节替换（但是这里的sbox是替换过的），移位，轮常数异或。44/4 = 11，这也说明了是aes_128，因为密钥11组。</p><p><img src="https://i.loli.net/2021/09/01/51NxLIjvF3lfT8X.png" alt="image-20210831212018020"></p><p>再是将另外一个参数存放在扩展密钥的尾部：</p><p><img src="https://i.loli.net/2021/09/01/Aoj8Q4YzOI5EPfX.png" alt="image-20210831212902803"></p><p>接着的sub_7B49340E6C函数也是很明显的aes_128_cbc加密，sub_7B4934097C中清晰的初始轮（轮密钥加），重复轮（字节替换，行移位，列混合，轮密钥加），最终轮（字节替换，行移位，轮密钥加）结构：</p><p><img src="https://i.loli.net/2021/09/01/MvGDm9iFVQZ1bBr.png" alt="image-20210831213127999"></p><p>最后sub_7B49340624函数rc4加密，但多异或了0x50：</p><p><img src="https://i.loli.net/2021/09/01/mc8Uue5BGsC7Mpl.png" alt="image-20210831213507809"></p><p>所以整体上本题的加密就是aes_128_cbc与rc4，麻烦的是数据部分，如aes的密钥，iv，rc4密钥与密文等。因为开始说了在.init_array中进行了很多数据的解密，我在静态分析看到的大多数数据都是没有解密的。那我们现在要么对分析到的数据找到引用修改的.init_array中的函数按照相同的运算逻辑手动patch修改；要么就是把程序调试起来，分析起来会简单很多。</p><p>这里我选择了动态调试。</p><p>首先将AndroidMannifest.xml中的<strong>android:extractNativeLibs=”false“</strong>改为true或者删掉，默认为true。因为这个如果为false会让我们在调试时找不到so</p><p><img src="https://i.loli.net/2021/09/01/Em4jeAbICkqVFuY.png" alt="image-20210831214326864"></p><p>然后因为我们调试的断点要断在<strong>JNI_OnLoad</strong>中（方便把注册的函数修改为正确的分支），那我们必须在程序还没执行<strong>System.loadLibrary(“native-lib”);</strong>之前就断下来，所以要程序要以调试模式启动。</p><p>首先我尝试了ida+jdb的组合：</p><blockquote><p>运行环境中root模式启动好相应的服务程序，转发端口到本地。(停止转发端口：<strong>adb forward –remove tcp:端口号<code>或</code>adb forward –remove-all</strong>)</p><p>使用am命令以调试启动app：adb shell am start -D -n come.wmctf.crackme111/.MainActivity</p><p>ida在JNI_OnLoad中下好断点，然后找到app对应的进程后附加，接着F9运行</p><p>打开ddms，用附加让app运行起来：jdb -connect com.sun.jdi.SocketAttach:hostname=127.0.0.1,port=8700</p></blockquote><p>但是这样做在jdb附加app就报如下的错误。这好像是我手机的原因？</p><p><img src="https://i.loli.net/2021/09/01/AapBzxRw2Uv8Y9u.png" alt="image-20210831215551116"></p><p>我使用jeb来附加app同样也是报错，这都是在我先用IDA附加了进程的情况下，接着我尝试发现先jdb或jeb附加再IDA附加是可以的，但这样程序已经运行过<strong>System.loadLibrary(“native-lib”);</strong>了。</p><p>而还有一个方法，我们可以使用jeb附加调试断在<strong>System.loadLibrary(“native-lib”);</strong>之前再用IDA去附加进程呀。</p><p><img src="https://i.loli.net/2021/09/01/nshTY1NwpkPWFSr.png" alt="image-20210901095150285"></p><p>然后成功断在JNI_OnLoad中，在正确分支下好断点，修改检测环境是否root的返回值为false，但是这个在native层运行完JNI_OnLoad函数回到java层的时候app又崩溃了。</p><p>最后干脆直接改so得了，就是把根据检测运行环境是否有su的返回值后的条件跳转改一下。</p><p><img src="https://i.loli.net/2021/09/01/zOmXTFrq483bZoM.png" alt="image-20210831234611072"></p><p>上面修改完后，把app重编译一下，然后普通的附加调试就好了。这也是调试本程序最简单的方法，上面绕了一大圈😂。</p><p>现在再看一下内存中解密后的数据，一目了然：<br><img src="https://i.loli.net/2021/09/01/AnKeum1spg8UWMC.png" alt="image-20210901000802876"></p><p>看到上面静态分析说的sub_7B4933FE80函数用fopen()打开了一个系统文件，现在调试过去发现原来是进程的状态信息：</p><p><img src="https://i.loli.net/2021/09/01/VdKjhXruy57g24C.png" alt="image-20210901002119587"></p><p>再看到后面要匹配的内容。</p><p><img src="https://i.loli.net/2021/09/01/ZI4FVAJx73hXOsT.png" alt="image-20210901002413399"></p><p>自己手动查看一下：</p><p><img src="https://i.loli.net/2021/09/01/2mdSZn8XcskBUFN.png" alt="image-20210901002729639"></p><p>接着直接调试到最后看获取的结果，就是要获取<strong>TracerPid:</strong>字段那一行的内容加上flg，而app正常不调试运行这个TracerPid是0的，所以这里获取的正确值为：<strong>TracerPid:\x090\x0Aflg</strong></p><p><img src="https://i.loli.net/2021/09/01/ZgiXE5c3qsU7u8D.png" alt="image-20210901003148346"></p><p>接着看到下面与上面的静态分析结合可以知道：程序中aes_128的key：<strong>TracerPid:\x090\x0Aflg</strong> iv：<strong>0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 0xA, 0xB, 0xC, 0xD, 0xE, 0xF</strong></p><p><img src="https://i.loli.net/2021/09/01/OFP17jzvpDQymXi.png" alt="image-20210901004032836"></p><p>再就是这个aes加密的sbox果然是替换了的，正常的sbox开头为：<strong>0x63, 0x7c, 0x77, 0x7b</strong></p><p><img src="https://i.loli.net/2021/09/01/J3vIc89jB15GXWh.png" alt="image-20210901004538811"></p><p>最后看到剩下的rc4加密，从传入参数看到密钥是<strong>Hello from C++</strong></p><p>下面开始解密。</p><p>首先rc4解密：</p><p>直接把输入的aes加密结果与最终经过rc4结果都提取出来异或一下得到异或序列，再将其与真正的密文异或一下得到真正的aes加密结果：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>s = [<span class="number">0xA4</span>, <span class="number">0xCD</span>, <span class="number">0xDA</span>, <span class="number">0x34</span>, <span class="number">0xA9</span>, <span class="number">0xE8</span>, <span class="number">0xFF</span>, <span class="number">0x48</span>, <span class="number">0xD6</span>, <span class="number">0x74</span>, <span class="number">0xE7</span>, <span class="number">0x0F</span>, <span class="number">0x71</span>, <span class="number">0xF7</span>, <span class="number">0xED</span>, <span class="number">0xB7</span>, <span class="number">0xC2</span>, <span class="number">0xA8</span>, <span class="number">0xE1</span>, <span class="number">0xE1</span>, <span class="number">0x0E</span>, <span class="number">0x2D</span>, <span class="number">0xD0</span>, <span class="number">0x8D</span>, <span class="number">0xF8</span>, <span class="number">0x20</span>, <span class="number">0x0E</span>, <span class="number">0x85</span>, <span class="number">0x1D</span>, <span class="number">0xBC</span>, <span class="number">0xC1</span>, <span class="number">0x61</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>t = []</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>t = [<span class="number">0x6C</span>, <span class="number">0xDB</span>, <span class="number">0xC6</span>, <span class="number">0x75</span>, <span class="number">0x4A</span>, <span class="number">0x94</span>, <span class="number">0xAA</span>, <span class="number">0xBD</span>, <span class="number">0xF5</span>, <span class="number">0x92</span>, <span class="number">0xCF</span>, <span class="number">0xB6</span>, <span class="number">0x4E</span>, <span class="number">0x0B</span>, <span class="number">0x38</span>, <span class="number">0x5B</span>, <span class="number">0x2E</span>, <span class="number">0x4F</span>, <span class="number">0x48</span>, <span class="number">0xFD</span>, <span class="number">0xE2</span>, <span class="number">0x7B</span>, <span class="number">0xE3</span>, <span class="number">0xFE</span>, <span class="number">0x64</span>, <span class="number">0x7E</span>, <span class="number">0xEA</span>, <span class="number">0xA7</span>, <span class="number">0xB5</span>, <span class="number">0x8D</span>, <span class="number">0x96</span>, <span class="number">0xF5</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ans = [s[i]^t[i] <span class="keyword">for</span> i <span class="keyword">in</span> range(len(s))]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ans</span><br><span class="line">[<span class="number">200</span>, <span class="number">22</span>, <span class="number">28</span>, <span class="number">65</span>, <span class="number">227</span>, <span class="number">124</span>, <span class="number">85</span>, <span class="number">245</span>, <span class="number">35</span>, <span class="number">230</span>, <span class="number">40</span>, <span class="number">185</span>, <span class="number">63</span>, <span class="number">252</span>, <span class="number">213</span>, <span class="number">236</span>, <span class="number">236</span>, <span class="number">231</span>, <span class="number">169</span>, <span class="number">28</span>, <span class="number">236</span>, <span class="number">86</span>, <span class="number">51</span>, <span class="number">115</span>, <span class="number">156</span>, <span class="number">94</span>, <span class="number">228</span>, <span class="number">34</span>, <span class="number">168</span>, <span class="number">49</span>, <span class="number">87</span>, <span class="number">148</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>enc = [<span class="number">0x18</span>, <span class="number">0x76</span>, <span class="number">0xEB</span>, <span class="number">0x87</span>, <span class="number">0x76</span>, <span class="number">0x3E</span>, <span class="number">0x77</span>, <span class="number">0x08</span>, <span class="number">0xC0</span>, <span class="number">0x8D</span>, <span class="number">0x56</span>, <span class="number">0x25</span>, <span class="number">0x9E</span>, <span class="number">0x35</span>, <span class="number">0x0D</span>, <span class="number">0x16</span>, <span class="number">0x23</span>, <span class="number">0x65</span>, <span class="number">0x61</span>, <span class="number">0x6A</span>, <span class="number">0x14</span>, <span class="number">0x9D</span>, <span class="number">0x4F</span>, <span class="number">0x1C</span>, <span class="number">0x64</span>, <span class="number">0x21</span>, <span class="number">0x7D</span>, <span class="number">0x78</span>, <span class="number">0xBA</span>, <span class="number">0x53</span>, <span class="number">0x91</span>, <span class="number">0x22</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>res = [ans[i]^enc[i] <span class="keyword">for</span> i <span class="keyword">in</span> range(len(enc))]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>res</span><br><span class="line">[<span class="number">208</span>, <span class="number">96</span>, <span class="number">247</span>, <span class="number">198</span>, <span class="number">149</span>, <span class="number">66</span>, <span class="number">34</span>, <span class="number">253</span>, <span class="number">227</span>, <span class="number">107</span>, <span class="number">126</span>, <span class="number">156</span>, <span class="number">161</span>, <span class="number">201</span>, <span class="number">216</span>, <span class="number">250</span>, <span class="number">207</span>, <span class="number">130</span>, <span class="number">200</span>, <span class="number">118</span>, <span class="number">248</span>, <span class="number">203</span>, <span class="number">124</span>, <span class="number">111</span>, <span class="number">248</span>, <span class="number">127</span>, <span class="number">153</span>, <span class="number">90</span>, <span class="number">18</span>, <span class="number">98</span>, <span class="number">198</span>, <span class="number">182</span>]</span><br></pre></td></tr></table></figure><p>然后aes解密：</p><p>将之前自己写过的aes_cbc加解密中的sbox替换为程序中的，rsbox简单对sbox求一下逆，最后解密即可：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//aes.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> AES_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AES_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt; </span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> Nk 4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> Nr 10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> Nb 4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> getSBoxValue(num) (sbox[(num)])</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">aes</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ctx_</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">char</span> RoundKey[<span class="number">11</span>*<span class="number">16</span>];</span><br><span class="line">    &#125;ctx;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    aes(<span class="keyword">char</span> *Key);</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">xor_iv</span><span class="params">(<span class="keyword">char</span> *a, <span class="keyword">char</span> *b)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">KeyExpansion</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *RoundKey, <span class="keyword">char</span> *Key)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">AddRoundKey</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> (*state)[<span class="number">4</span>], <span class="keyword">unsigned</span> <span class="keyword">char</span> *RoundKey)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">SubBytes</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> (*state)[<span class="number">4</span>])</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">ShiftRows</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> (*state)[<span class="number">4</span>])</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="keyword">char</span> <span class="title">gfmultby</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> a, <span class="keyword">unsigned</span> <span class="keyword">char</span> b)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">MixColumns</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> (*state)[<span class="number">4</span>])</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">getData</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> (*data)[<span class="number">4</span>], <span class="keyword">char</span> *enc)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">encryption_cbc</span><span class="params">(<span class="keyword">char</span> *plaint, <span class="keyword">char</span> *enc)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">InvSubBytes</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> (*state)[<span class="number">4</span>])</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">InvShiftRows</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> (*state)[<span class="number">4</span>])</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">InvMixColumns</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> (*state)[<span class="number">4</span>])</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">decryption_cbc</span><span class="params">(<span class="keyword">char</span> *plaint, <span class="keyword">char</span> *enc)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// AES_H</span></span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//main.cpp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"aes.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> sbox[<span class="number">256</span>] = &#123;</span><br><span class="line">  <span class="comment">//0     1    2      3     4    5     6     7      8    9     A      B    C     D     E     F</span></span><br><span class="line">  <span class="number">0x7C</span>, <span class="number">0xF2</span>, <span class="number">0x63</span>, <span class="number">0x7B</span>, <span class="number">0x77</span>, <span class="number">0x6B</span>, <span class="number">0x6F</span>, <span class="number">0xC5</span>, <span class="number">0x30</span>, <span class="number">0x01</span>, <span class="number">0x67</span>, <span class="number">0x2B</span>, <span class="number">0xFE</span>, <span class="number">0xD7</span>, <span class="number">0xAB</span>, <span class="number">0x76</span>, <span class="number">0xCA</span>, <span class="number">0x82</span>, <span class="number">0xC9</span>, <span class="number">0x7D</span>, <span class="number">0xFA</span>, <span class="number">0x59</span>, <span class="number">0x47</span>, <span class="number">0xF0</span>, <span class="number">0xAD</span>, <span class="number">0xD4</span>, <span class="number">0xA2</span>, <span class="number">0xAF</span>, <span class="number">0x9C</span>, <span class="number">0xA4</span>, <span class="number">0x72</span>, <span class="number">0xC0</span>, <span class="number">0xB7</span>, <span class="number">0xFD</span>, <span class="number">0x93</span>, <span class="number">0x26</span>, <span class="number">0x36</span>, <span class="number">0x3F</span>, <span class="number">0xF7</span>, <span class="number">0xCC</span>, <span class="number">0x34</span>, <span class="number">0xA5</span>, <span class="number">0xE5</span>, <span class="number">0xF1</span>, <span class="number">0x71</span>, <span class="number">0xD8</span>, <span class="number">0x31</span>, <span class="number">0x15</span>, <span class="number">0x04</span>, <span class="number">0xC7</span>, <span class="number">0x23</span>, <span class="number">0xC3</span>, <span class="number">0x18</span>, <span class="number">0x96</span>, <span class="number">0x05</span>, <span class="number">0x9A</span>, <span class="number">0x07</span>, <span class="number">0x12</span>, <span class="number">0x80</span>, <span class="number">0xE2</span>, <span class="number">0xEB</span>, <span class="number">0x27</span>, <span class="number">0xB2</span>, <span class="number">0x75</span>, <span class="number">0x09</span>, <span class="number">0x83</span>, <span class="number">0x2C</span>, <span class="number">0x1A</span>, <span class="number">0x1B</span>, <span class="number">0x6E</span>, <span class="number">0x5A</span>, <span class="number">0xA0</span>, <span class="number">0x52</span>, <span class="number">0x3B</span>, <span class="number">0xD6</span>, <span class="number">0xB3</span>, <span class="number">0x29</span>, <span class="number">0xE3</span>, <span class="number">0x2F</span>, <span class="number">0x84</span>, <span class="number">0x53</span>, <span class="number">0xD1</span>, <span class="number">0x00</span>, <span class="number">0xED</span>, <span class="number">0x20</span>, <span class="number">0xFC</span>, <span class="number">0xB1</span>, <span class="number">0x5B</span>, <span class="number">0x6A</span>, <span class="number">0xCB</span>, <span class="number">0xBE</span>, <span class="number">0x39</span>, <span class="number">0x4A</span>, <span class="number">0x4C</span>, <span class="number">0x58</span>, <span class="number">0xCF</span>, <span class="number">0xD0</span>, <span class="number">0xEF</span>, <span class="number">0xAA</span>, <span class="number">0xFB</span>, <span class="number">0x43</span>, <span class="number">0x4D</span>, <span class="number">0x33</span>, <span class="number">0x85</span>, <span class="number">0x45</span>, <span class="number">0xF9</span>, <span class="number">0x02</span>, <span class="number">0x7F</span>, <span class="number">0x50</span>, <span class="number">0x3C</span>, <span class="number">0x9F</span>, <span class="number">0xA8</span>, <span class="number">0x51</span>, <span class="number">0xA3</span>, <span class="number">0x40</span>, <span class="number">0x8F</span>, <span class="number">0x92</span>, <span class="number">0x9D</span>, <span class="number">0x38</span>, <span class="number">0xF5</span>, <span class="number">0xBC</span>, <span class="number">0xB6</span>, <span class="number">0xDA</span>, <span class="number">0x21</span>, <span class="number">0x10</span>, <span class="number">0xFF</span>, <span class="number">0xF3</span>, <span class="number">0xD2</span>, <span class="number">0x0C</span>, <span class="number">0xCD</span>, <span class="number">0x13</span>, <span class="number">0xEC</span>, <span class="number">0x5F</span>, <span class="number">0x97</span>, <span class="number">0x44</span>, <span class="number">0x17</span>, <span class="number">0xC4</span>, <span class="number">0xA7</span>, <span class="number">0x7E</span>, <span class="number">0x3D</span>, <span class="number">0x64</span>, <span class="number">0x5D</span>, <span class="number">0x19</span>, <span class="number">0x73</span>, <span class="number">0x60</span>, <span class="number">0x81</span>, <span class="number">0x4F</span>, <span class="number">0xDC</span>, <span class="number">0x22</span>, <span class="number">0x2A</span>, <span class="number">0x90</span>, <span class="number">0x88</span>, <span class="number">0x46</span>, <span class="number">0xEE</span>, <span class="number">0xB8</span>, <span class="number">0x14</span>, <span class="number">0xDE</span>, <span class="number">0x5E</span>, <span class="number">0x0B</span>, <span class="number">0xDB</span>, <span class="number">0xE0</span>, <span class="number">0x32</span>, <span class="number">0x3A</span>, <span class="number">0x0A</span>, <span class="number">0x49</span>, <span class="number">0x06</span>, <span class="number">0x24</span>, <span class="number">0x5C</span>, <span class="number">0xC2</span>, <span class="number">0xD3</span>, <span class="number">0xAC</span>, <span class="number">0x62</span>, <span class="number">0x91</span>, <span class="number">0x95</span>, <span class="number">0xE4</span>, <span class="number">0x79</span>, <span class="number">0xE7</span>, <span class="number">0xC8</span>, <span class="number">0x37</span>, <span class="number">0x6D</span>, <span class="number">0x8D</span>, <span class="number">0xD5</span>, <span class="number">0x4E</span>, <span class="number">0xA9</span>, <span class="number">0x6C</span>, <span class="number">0x56</span>, <span class="number">0xF4</span>, <span class="number">0xEA</span>, <span class="number">0x65</span>, <span class="number">0x7A</span>, <span class="number">0x08</span>, <span class="number">0xAE</span>, <span class="number">0xBA</span>, <span class="number">0x78</span>, <span class="number">0x25</span>, <span class="number">0x2E</span>, <span class="number">0x1C</span>, <span class="number">0xA6</span>, <span class="number">0xB4</span>, <span class="number">0xC6</span>, <span class="number">0xE8</span>, <span class="number">0xDD</span>, <span class="number">0x74</span>, <span class="number">0x1F</span>, <span class="number">0x4B</span>, <span class="number">0xBD</span>, <span class="number">0x8B</span>, <span class="number">0x8A</span>, <span class="number">0x70</span>, <span class="number">0x3E</span>, <span class="number">0xB5</span>, <span class="number">0x66</span>, <span class="number">0x48</span>, <span class="number">0x03</span>, <span class="number">0xF6</span>, <span class="number">0x0E</span>, <span class="number">0x61</span>, <span class="number">0x35</span>, <span class="number">0x57</span>, <span class="number">0xB9</span>, <span class="number">0x86</span>, <span class="number">0xC1</span>, <span class="number">0x1D</span>, <span class="number">0x9E</span>, <span class="number">0xE1</span>, <span class="number">0xF8</span>, <span class="number">0x98</span>, <span class="number">0x11</span>, <span class="number">0x69</span>, <span class="number">0xD9</span>, <span class="number">0x8E</span>, <span class="number">0x94</span>, <span class="number">0x9B</span>, <span class="number">0x1E</span>, <span class="number">0x87</span>, <span class="number">0xE9</span>, <span class="number">0xCE</span>, <span class="number">0x55</span>, <span class="number">0x28</span>, <span class="number">0xDF</span>, <span class="number">0x8C</span>, <span class="number">0xA1</span>, <span class="number">0x89</span>, <span class="number">0x0D</span>, <span class="number">0xBF</span>, <span class="number">0xE6</span>, <span class="number">0x42</span>, <span class="number">0x68</span>, <span class="number">0x41</span>, <span class="number">0x99</span>, <span class="number">0x2D</span>, <span class="number">0x0F</span>, <span class="number">0xB0</span>, <span class="number">0x54</span>, <span class="number">0xBB</span>, <span class="number">0x16</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> rsbox[<span class="number">256</span>] = &#123;<span class="number">0</span>&#125;; </span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> Rcon[<span class="number">11</span>] = &#123;</span><br><span class="line">  <span class="number">0x8d</span>, <span class="number">0x01</span>, <span class="number">0x02</span>, <span class="number">0x04</span>, <span class="number">0x08</span>, <span class="number">0x10</span>, <span class="number">0x20</span>, <span class="number">0x40</span>, <span class="number">0x80</span>, <span class="number">0x1b</span>, <span class="number">0x36</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> MixValue[<span class="number">4</span>][<span class="number">4</span>] = &#123;&#123;<span class="number">02</span>, <span class="number">03</span>, <span class="number">01</span>, <span class="number">01</span>&#125;,</span><br><span class="line">                                      &#123;<span class="number">01</span>, <span class="number">02</span>, <span class="number">03</span>, <span class="number">01</span>&#125;,</span><br><span class="line">                                      &#123;<span class="number">01</span>, <span class="number">01</span>, <span class="number">02</span>, <span class="number">03</span>&#125;,</span><br><span class="line">                                      &#123;<span class="number">03</span>, <span class="number">01</span>, <span class="number">01</span>, <span class="number">02</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> InvMixValue[<span class="number">4</span>][<span class="number">4</span>] = &#123;&#123;<span class="number">0xe</span>, <span class="number">0xb</span>, <span class="number">0xd</span>, <span class="number">0x9</span>&#125;,</span><br><span class="line">                                         &#123;<span class="number">0x9</span>, <span class="number">0xe</span>, <span class="number">0xb</span>, <span class="number">0xd</span>&#125;,</span><br><span class="line">                                         &#123;<span class="number">0xd</span>, <span class="number">0x9</span>, <span class="number">0xe</span>, <span class="number">0xb</span>&#125;,</span><br><span class="line">                                         &#123;<span class="number">0xb</span>, <span class="number">0xd</span>, <span class="number">0x9</span>, <span class="number">0xe</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">aes::aes(<span class="keyword">char</span> *key)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">this</span>-&gt;KeyExpansion(ctx.RoundKey, key);</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">    	rsbox[sbox[i]] = i;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> aes::xor_iv(<span class="keyword">char</span> *data, <span class="keyword">char</span> *iv)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++)</span><br><span class="line">        data[i] ^= iv[i];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> aes::KeyExpansion(<span class="keyword">unsigned</span> <span class="keyword">char</span> *RoundKey, <span class="keyword">char</span> *Key)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> i, j, k;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> tempa[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; Nk; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        RoundKey[(i * <span class="number">4</span>) + <span class="number">0</span>] = Key[(i * <span class="number">4</span>) + <span class="number">0</span>];</span><br><span class="line">        RoundKey[(i * <span class="number">4</span>) + <span class="number">1</span>] = Key[(i * <span class="number">4</span>) + <span class="number">1</span>];</span><br><span class="line">        RoundKey[(i * <span class="number">4</span>) + <span class="number">2</span>] = Key[(i * <span class="number">4</span>) + <span class="number">2</span>];</span><br><span class="line">        RoundKey[(i * <span class="number">4</span>) + <span class="number">3</span>] = Key[(i * <span class="number">4</span>) + <span class="number">3</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = Nk; i &lt; Nb * (Nr + <span class="number">1</span>); ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        k = (i - <span class="number">1</span>) * <span class="number">4</span>;</span><br><span class="line">        tempa[<span class="number">0</span>]=RoundKey[k + <span class="number">0</span>];</span><br><span class="line">        tempa[<span class="number">1</span>]=RoundKey[k + <span class="number">1</span>];</span><br><span class="line">        tempa[<span class="number">2</span>]=RoundKey[k + <span class="number">2</span>];</span><br><span class="line">        tempa[<span class="number">3</span>]=RoundKey[k + <span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (i % Nk == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> u8tmp = tempa[<span class="number">0</span>];</span><br><span class="line">            tempa[<span class="number">0</span>] = tempa[<span class="number">1</span>];</span><br><span class="line">            tempa[<span class="number">1</span>] = tempa[<span class="number">2</span>];</span><br><span class="line">            tempa[<span class="number">2</span>] = tempa[<span class="number">3</span>];</span><br><span class="line">            tempa[<span class="number">3</span>] = u8tmp;</span><br><span class="line"></span><br><span class="line">            tempa[<span class="number">0</span>] = getSBoxValue(tempa[<span class="number">0</span>]);</span><br><span class="line">            tempa[<span class="number">1</span>] = getSBoxValue(tempa[<span class="number">1</span>]);</span><br><span class="line">            tempa[<span class="number">2</span>] = getSBoxValue(tempa[<span class="number">2</span>]);</span><br><span class="line">            tempa[<span class="number">3</span>] = getSBoxValue(tempa[<span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line">            tempa[<span class="number">0</span>] = tempa[<span class="number">0</span>] ^ Rcon[i/Nk];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        j = i * <span class="number">4</span>; k=(i - Nk) * <span class="number">4</span>;</span><br><span class="line">        RoundKey[j + <span class="number">0</span>] = RoundKey[k + <span class="number">0</span>] ^ tempa[<span class="number">0</span>];</span><br><span class="line">        RoundKey[j + <span class="number">1</span>] = RoundKey[k + <span class="number">1</span>] ^ tempa[<span class="number">1</span>];</span><br><span class="line">        RoundKey[j + <span class="number">2</span>] = RoundKey[k + <span class="number">2</span>] ^ tempa[<span class="number">2</span>];</span><br><span class="line">        RoundKey[j + <span class="number">3</span>] = RoundKey[k + <span class="number">3</span>] ^ tempa[<span class="number">3</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> aes::AddRoundKey(<span class="keyword">unsigned</span> <span class="keyword">char</span> (*state)[<span class="number">4</span>], <span class="keyword">unsigned</span> <span class="keyword">char</span> *RoundKey)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> i, j;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">4</span> ;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            state[i][j] ^=  RoundKey[j*<span class="number">4</span>+i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> aes::InvSubBytes(<span class="keyword">unsigned</span> <span class="keyword">char</span> (*state)[<span class="number">4</span>])</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> i, j;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            state[i][j] = rsbox[state[i][j]];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> aes::InvShiftRows(<span class="keyword">unsigned</span> <span class="keyword">char</span> (*state)[<span class="number">4</span>])</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> i, j, cnt, tmp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">1</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        cnt = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(cnt++ &lt; i)</span><br><span class="line">        &#123;</span><br><span class="line">            tmp = state[i][<span class="number">3</span>];</span><br><span class="line">            <span class="keyword">for</span>(j = <span class="number">3</span>; j &gt; <span class="number">0</span>; j--)</span><br><span class="line">            &#123;</span><br><span class="line">                state[i][j] = state[i][j<span class="number">-1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            state[i][j] = tmp;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> aes::gfmultby(<span class="keyword">unsigned</span> <span class="keyword">char</span> a, <span class="keyword">unsigned</span> <span class="keyword">char</span> b)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> tmp = a &gt;= <span class="number">0x80</span> ? (<span class="keyword">unsigned</span> <span class="keyword">char</span>)((a&lt;&lt;<span class="number">1</span>)^<span class="number">0x1b</span>):(<span class="keyword">unsigned</span> <span class="keyword">char</span>)(a &lt;&lt; <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(b == <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(b == <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">return</span> tmp;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(b == <span class="number">3</span>)</span><br><span class="line">        <span class="keyword">return</span> tmp^a;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(b == <span class="number">4</span>)</span><br><span class="line">        <span class="keyword">return</span> gfmultby(tmp, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(b == <span class="number">8</span>)</span><br><span class="line">        <span class="keyword">return</span> gfmultby(gfmultby(tmp, <span class="number">2</span>), <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(b == <span class="number">9</span>)</span><br><span class="line">        <span class="keyword">return</span> gfmultby(gfmultby(tmp, <span class="number">2</span>), <span class="number">2</span>)^a;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(b == <span class="number">10</span>)</span><br><span class="line">        <span class="keyword">return</span> gfmultby(gfmultby(tmp, <span class="number">2</span>), <span class="number">2</span>)^tmp;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(b == <span class="number">11</span>)</span><br><span class="line">        <span class="keyword">return</span> gfmultby(gfmultby(tmp, <span class="number">2</span>), <span class="number">2</span>)^tmp^a;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(b == <span class="number">12</span>)</span><br><span class="line">        <span class="keyword">return</span> gfmultby(gfmultby(tmp, <span class="number">2</span>), <span class="number">2</span>)^gfmultby(tmp, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(b == <span class="number">13</span>)</span><br><span class="line">        <span class="keyword">return</span> gfmultby(gfmultby(tmp, <span class="number">2</span>), <span class="number">2</span>)^gfmultby(tmp, <span class="number">2</span>)^a;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> gfmultby(gfmultby(tmp, <span class="number">2</span>), <span class="number">2</span>)^gfmultby(tmp, <span class="number">2</span>)^tmp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> aes::InvMixColumns(<span class="keyword">unsigned</span> <span class="keyword">char</span> (*state)[<span class="number">4</span>])</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> i, j, k;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> output[<span class="number">4</span>][<span class="number">4</span>] = &#123;&#123;<span class="number">0</span>&#125;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span>(k = <span class="number">0</span>; k &lt; <span class="number">4</span>; k++)</span><br><span class="line">            &#123;</span><br><span class="line">                output[i][j] ^= gfmultby(state[k][j], InvMixValue[i][k]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            state[i][j] = output[i][j];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> aes::getData(<span class="keyword">unsigned</span> <span class="keyword">char</span> (*data)[<span class="number">4</span>], <span class="keyword">char</span> *plaint)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> i, j;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            data[j][i] = plaint[<span class="number">4</span>*i+j];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> aes::decryption_cbc(<span class="keyword">char</span> *enc, <span class="keyword">char</span> *plain)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">10</span>, j = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> state[<span class="number">4</span>][<span class="number">4</span>] = &#123;&#123;<span class="number">0</span>&#125;&#125;, output[<span class="number">4</span>][<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">    aes::getData(state, enc);</span><br><span class="line"></span><br><span class="line">    aes::AddRoundKey(state, ctx.RoundKey+i*<span class="number">16</span>);</span><br><span class="line">    <span class="keyword">for</span>(i--; ; i--)</span><br><span class="line">    &#123;</span><br><span class="line">        aes::InvShiftRows(state);</span><br><span class="line">        aes::InvSubBytes(state);</span><br><span class="line">        aes::AddRoundKey(state, ctx.RoundKey+i*<span class="number">16</span>);</span><br><span class="line">        <span class="keyword">if</span>(i == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        aes::InvMixColumns(state);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            output[i][j] = state[j][i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++)</span><br><span class="line">        plain[i] = ((<span class="keyword">char</span> *)output)[i];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> key[] = &#123;<span class="number">84</span>, <span class="number">114</span>, <span class="number">97</span>, <span class="number">99</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">80</span>, <span class="number">105</span>, <span class="number">100</span>, <span class="number">58</span>, <span class="number">9</span>, <span class="number">48</span>, <span class="number">10</span>, <span class="number">102</span>, <span class="number">108</span>, <span class="number">103</span>&#125;;</span><br><span class="line">	<span class="keyword">char</span> iv[] = &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">0xA</span>, <span class="number">0xB</span>, <span class="number">0xC</span>, <span class="number">0xD</span>, <span class="number">0xE</span>, <span class="number">0xF</span>&#125;;</span><br><span class="line">	<span class="keyword">char</span> plain[<span class="number">100</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">char</span> enc[] = &#123;<span class="number">208</span>, <span class="number">96</span>, <span class="number">247</span>, <span class="number">198</span>, <span class="number">149</span>, <span class="number">66</span>, <span class="number">34</span>, <span class="number">253</span>, <span class="number">227</span>, <span class="number">107</span>, <span class="number">126</span>, <span class="number">156</span>, <span class="number">161</span>, <span class="number">201</span>, <span class="number">216</span>, <span class="number">250</span>, <span class="number">207</span>, <span class="number">130</span>, <span class="number">200</span>, <span class="number">118</span>, <span class="number">248</span>, <span class="number">203</span>, <span class="number">124</span>, <span class="number">111</span>, <span class="number">248</span>, <span class="number">127</span>, <span class="number">153</span>, <span class="number">90</span>, <span class="number">18</span>, <span class="number">98</span>, <span class="number">198</span>, <span class="number">182</span>&#125;;</span><br><span class="line">	</span><br><span class="line">	aes *cry = <span class="keyword">new</span> aes(key);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">32</span>; i += <span class="number">16</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		cry-&gt;decryption_cbc(enc+i, plain+i);</span><br><span class="line">		<span class="keyword">if</span>(i == <span class="number">0</span>)</span><br><span class="line">			cry-&gt;xor_iv(plain+i, iv);</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			cry-&gt;xor_iv(plain+i, enc+(i<span class="number">-16</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">puts</span>(plain);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后解密得到：<strong>wmctf{e78ce1a3ac4be37a96e27e98c}</strong></p></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>Post author:</strong> ooo</li><li class="post-copyright-link"> <strong>Post link:</strong> <a href="https://bxb0.github.io/2021/09/01/2021WMCTF/" title="2021WMCTF">https://bxb0.github.io/2021/09/01/2021WMCTF/</a></li><li class="post-copyright-license"> <strong>Copyright Notice:</strong> All articles in this blog are licensed under<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i> BY-NC-SA</a> unless stating additionally.</li></ul></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><footer class="post-footer"><div class="post-nav"><div class="post-nav-item"><a href="/2021/08/26/2021%E8%93%9D%E5%B8%BD%E6%80%BB%E5%86%B3%E8%B5%9B/" rel="prev" title="2021蓝帽总决赛"><i class="fa fa-chevron-left"></i> 2021蓝帽总决赛</a></div><div class="post-nav-item"></div></div></footer></article></div><script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> Table of Contents</li><li class="sidebar-nav-overview"> Overview</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Re1"><span class="nav-number">1.</span> <span class="nav-text">Re1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Re2"><span class="nav-number">2.</span> <span class="nav-text">Re2</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">ooo</p><div class="site-description" itemprop="description">0x446e37fb</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">45</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">15</span> <span class="site-state-item-name">categories</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">3</span> <span class="site-state-item-name">tags</span></a></div></nav></div><div class="cc-license motion-element" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a></div><div class="links-of-blogroll motion-element"><div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"> <a href="https://i0gan.github.io/" title="https:&#x2F;&#x2F;i0gan.github.io&#x2F;" rel="noopener" target="_blank">i0gan</a></li><li class="links-of-blogroll-item"> <a href="http://pipinstall.cn/" title="http:&#x2F;&#x2F;pipinstall.cn" rel="noopener" target="_blank">ttfpx</a></li><li class="links-of-blogroll-item"> <a href="https://vino0o0o.github.io/" title="https:&#x2F;&#x2F;vino0o0o.github.io&#x2F;" rel="noopener" target="_blank">Vino0o0o</a></li><li class="links-of-blogroll-item"> <a href="https://github.com/Firebasky" title="https:&#x2F;&#x2F;github.com&#x2F;Firebasky" rel="noopener" target="_blank">Firebasky</a></li><li class="links-of-blogroll-item"> <a href="http://xuan.pipinstall.cn/" title="http:&#x2F;&#x2F;xuan.pipinstall.cn&#x2F;" rel="noopener" target="_blank">xuan</a></li><li class="links-of-blogroll-item"> <a href="https://hack-for.fun/" title="https:&#x2F;&#x2F;hack-for.fun&#x2F;" rel="noopener" target="_blank">M0nk3y</a></li><li class="links-of-blogroll-item"> <a href="http://happi0.gitee.io/" title="http:&#x2F;&#x2F;happi0.gitee.io&#x2F;" rel="noopener" target="_blank">happi0</a></li><li class="links-of-blogroll-item"> <a href="https://the_itach1.gitee.io/" title="https:&#x2F;&#x2F;the_itach1.gitee.io&#x2F;" rel="noopener" target="_blank">The_Itach1</a></li></ul></div></div><div class="back-to-top motion-element"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2022</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">ooo</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-chart-area"></i></span> <span class="post-meta-item-text">Symbols count total:</span> <span title="Symbols count total">377k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span class="post-meta-item-text">Reading time total &asymp;</span> <span title="Reading time total">5:43</span></div></div></footer></div><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><script type="text/javascript" src="/js/src/clicklove.js"></script><script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,model:{jsonPath:"/live2dw/assets/wanko.model.json"},display:{position:"left",width:150,height:300},mobile:{show:!0},log:!1})</script></body></html>